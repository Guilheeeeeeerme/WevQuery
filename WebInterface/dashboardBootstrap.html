<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

  <title>User log query abstraction language</title>

  <!-- Bootstrap -->
  <link href="bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styleDrag.css">
  <link rel="stylesheet" href="./jquery-ui-1.12.1/jquery-ui.css">

  <script src="./jquery-ui-1.12.1/external/jquery/jquery.js"></script>
  <script src="./jquery-ui-1.12.1/jquery-ui.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  <!-- The event creation and interaction logic is stored in a different file -->
  <script src="./eventCreation.js"></script>

  <script>

  $(function() {
     var $eventPaletteArea = $("#eventPaletteArea"),
      $eventOrderArea = $("#eventOrderArea");      
      
      $eventPaletteArea.sortable({
          scroll: true,
         // revert: true,//when cancelled, element returns to origin with animation
          handle: "span",//elements can only be dragged using the handle
          cancel: "#eventPaletteArea li p",//the rest of the text can be selected
          connectWith: $eventOrderArea,//both areas are conected, so elements can be dragged around,
          helper:"clone",
          //revert:"invalid",
          start: function(event, ui) {
            if ($(ui.item).hasClass("eventOrdered")) {
              throw "cancel";
            }
          },
          stop: function(event, ui) {
            if ($(ui.item).parents('#eventOrderArea').length > 0) {
              //Code to keep a copy of the event in the palette, if it has been dragged to the event order.
              //select the element before the one we are ending the drag on
              var idx = $("#eventOrderArea").children().index($(ui.item[0]))-1;
              var elm = $(ui.item[0]).clone(true);
              
              //if index is greater or equal to 0 then we can put it after that index
              //otherwise, append it to the list as first element 
              if(idx>-1)
                $("#eventOrderArea").children(':eq('+idx+')').after(elm);
              else
                $("#eventOrderArea").prepend(elm);
              $(this).sortable('cancel');
              updateTemporalConstraints();
            }
          }
      });    

      $eventOrderArea.sortable({
          scroll: true,
          //revert: true,
          handle: "span",
          cancel: "#eventOrderArea li p",
          connectWith: $eventPaletteArea,
          containment: "#eventOrderArea",

          stop: function(event, ui) {
            updateTemporalConstraints();
          }
      });
      
      //temporal constraints are resizable
      $('.tempConstraintObject').resizable({
        //resize is triggered when interaction with handles occurs
        handles: "w,e",
        //The height won't change
        maxHeight: 25,
        minHeight: 25,
        //the element should not get too small,
        minWidth: 400,
        //When it stops, it will check the element on top of it, and change the reference events accordingly. 
        stop: function(event, ui) {
          var tempConstraint = $(this);
          var startConstraint = $(tempConstraint).position().left;// + $("#eventOrderArea").scrollLeft();
          var endConstraint = startConstraint + $(tempConstraint).width();

          //We will loop through all events in ordered area to find the new start and end of the constraints 
          var startConstraintFound = false;
          var endConstraintFound = false;

          //Loop through all events in the ordered area to find the one this temporal constraint refers to now.
          //There are other options (such as find element in coordinate X Y) but this approach makes changing selection criteria easy
          //We may want to allow the user to select the event the constraint coveres completely, or rather the one the constraint touches.
          $("#eventOrderArea .eventTemplate").each(function(index,value){
            //get the left and right coordinates of the temp constraint
            var eventLeft = $(this).position().left + $("#eventOrderArea").scrollLeft();
            var eventRight = eventLeft + $(this).width();

            //Check if the start of the constraint falls within the dimensions of this event.If so, update the start reference 
            if(!startConstraintFound && eventLeft <= startConstraint && startConstraint <= eventRight){
              $(tempConstraint).attr("start",$(this).attr("id"));
              startConstraintFound = true;
              //console.log("Found left constraint event: " + index);
            }

            //Check if the end of the constraint falls within the dimensions of this event. If so, update the start reference 
            if(!endConstraintFound && eventLeft <= endConstraint && endConstraint <= eventRight){
              $(tempConstraint).attr("end",$(this).attr("id"));
              endConstraintFound = true;
              //console.log("Found right constraint event: " + index);
            }
          });
          updateTemporalConstraints();
        }
      });

      var dialog, form,
 
      // From http://www.whatwg.org/specs/web-apps/current-work/multipage/states-of-the-type-attribute.html#e-mail-state-%28type=email%29
      emailRegex = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/,
      name = $( "#name" ),
      email = $( "#email" ),
      password = $( "#password" ),
      allFields = $( [] ).add( name ).add( email ).add( password ),
      tips = $( ".validateTips" );

      eventDialog = $( "#eventTemplateDialog" ).dialog({
        autoOpen: false,//it should not open unless called
        height: 400,
        width: 350,
        modal: true,//disables all other items in the page
        //Adds two buttons, to either add an Event Template or cancel
        buttons: {
          "Create an Event template": addEventTemplate,
          Cancel: function() {
            eventDialog.dialog( "close" );
          }
        },

        //Pressing the "close" icon topright 
        close: function() {
          form[ 0 ].reset();
          allFields.removeClass( "ui-state-error" );
        }
      });

    //Enables the "submit" function that can be triggered via keyboard
    form = eventDialog.find( "form" ).on( "submit", function( event ) {
      event.preventDefault();
      addEventTemplate();
    });
 
    $( "#newEventButton" ).button().on( "click", function() {
      eventDialog.dialog( "open" );
    });

    updateTemporalConstraints();
  });

/**TODO: I need to call this function when the elements get dragged*/
  function updateTemporalConstraints(){
 //Update Existing temporal restriction
    
    $("#tempConstraintsArea .tempConstraintObject").each(function( index ) {
      //console.log( "tempConstraintObject number" + index);

      var temConstraintTopPadding = 35*(index+1);

      var $startEvent = $("#"+$(this).attr("start"));
      var $endEvent = $("#"+$(this).attr("end"));

      var constraintBottomCoord = $startEvent.position().top + $startEvent.height() + temConstraintTopPadding;

      //We need to add the scroll position to the coordinates
      var constraintLeftCoord = $startEvent.position().left + $("#eventOrderDiv").scrollLeft();
      
      //outerWidth(true) returns the width including the outer margin, which makes the constraints slightly surround the events. 
      var constraintWidth = (($endEvent.position().left + $endEvent.outerWidth(true) + $("#eventOrderDiv").scrollLeft()) - constraintLeftCoord) + "px";

      //console.log( "Drawing from " + constraintLeftCoord + " with size "+ constraintWidth);

      $(this).css({top: constraintBottomCoord, left: constraintLeftCoord, width: constraintWidth, position:'absolute'});
      $(".tempConstraintMessage",this).text($(this).attr("type") +" "+ $(this).attr("value") +" "+ $(this).attr("unit"))

      //The padding on the bottom will increase depending on the number of constraints. 30px per constraint
      $("#eventOrderDiv").css({
        paddingBottom: (index+1)*40+"px",
      })
    });
  }
  
  
  </script>
</head>

<body>
  <button onclick="updateTemporalConstraints"></button>
  <h1> Interaction Dashboard </h1>
  <div id="eventPaletteDiv" class="container">
    <h2> Event Palette </h2>

    <div class="row">
      <li class="eventTemplate eventTemplateExample">
        <div id="templateExample"> Event Example <span id="newEventButton" class="glyphicon glyphicon-plus" aria-hidden="true" aria-label="Add Event"></span></div>
        <p> Events:</p>
        <p>mouseover,mouseout</p>
        <p> Occurrence:</p>
        <p> Context</p>
        <p> ndoeID:"submit"</p>
      </li>

      <ul id="eventPaletteArea">
        <li id="event1" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 1 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
          <p> Events:</p>
          <p>mouseover,mouseout</p>
          <p> Occurrence:</p>
          <p> Context</p>
          <p> ndoeID:"submit"</p>
        </li>
        <li id="event2" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 2 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
          <p> Events:</p>
          <p>mouseover,mouseout</p>
          <p> Occurrence:</p>
          <p> Context</p>
          <p> ndoeID:"submit"</p>
        </li>

        <li id="event3" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 3 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
          <p> Events:</p>
          <p>mouseover,mouseout</p>
          <p> Occurrence:</p>
          <p> Context</p>
          <p> ndoeID:"submit"</p>
        </li>

        <li id="event4" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 4 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
          <p> Events:</p>
          <p>mouseover,mouseout</p>
          <p> Occurrence:</p>
          <p> Context</p>
          <p> ndoeID:"submit"</p>
        </li>

        <li id="event5" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 5 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
          <p> Events:</p>
          <p>mouseover,mouseout</p>
          <p> Occurrence:</p>
          <p> Context</p>
          <p> ndoeID:"submit"</p>
        </li>

        <li id="event6" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 6 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
        </li>
        <li id="event7" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 7 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
        </li>
      </ul>
      </div>
      </div>
      <h2> Event Order Area </h2>

      <div id="eventOrderDiv" class="container">
        <ul id="eventOrderArea">
          <li id="event8" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 8 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
            <p> Events:</p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
          </li>
          <li id="event9" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 9 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
            <p> Events:</p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
          </li>

          <li id="event10" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 10 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
            <p> Events:</p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
          </li>

          <li id="event11" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 11 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
            <p> Events:</p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
          </li>

          <li id="event12" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 12 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
            <p> Events:</p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
          </li>

          <li id="event13" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 13 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
              <p>mouseover,mouseout</p>
              <p> Occurrence:</p>
              <p> Context</p>
              <p> ndoeID:"submit"</p>
          </li>
          <li id="event14" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 14 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
              <p>mouseover,mouseout</p>
              <p> Occurrence:</p>
              <p> Context</p>
              <p> ndoeID:"submit"</p>
          </li>
          <li id="event15" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 15 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
              <p> Events:</p>
              <p>mouseover,mouseout</p>
              <p> Occurrence:</p>
              <p> Context</p>
              <p> ndoeID:"submit"</p>
          </li>
          <li id="event16" class="eventTemplate eventTemplateDraggable">
            <div id="title"> event 16 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
              <p>mouseover,mouseout</p>
              <p> Occurrence:</p>
              <p> Context</p>
              <p> ndoeID:"submit"</p>
          </li>
          <li id="event17" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 17 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
              <p>mouseover,mouseout</p>
              <p> Occurrence:</p>
              <p> Context</p>
              <p> ndoeID:"submit"</p>
          </li>
        </ul>
        <div id="tempConstraintsArea">
          <div id="tempConstId8toId10" class="tempConstraintObject" start="event8" end="event10" type="within" value="10" unit="sec">
            <p class="tempConstraintMessage"></p>
            <span class="glyphicon glyphicon-resize-horizontal ui-resizable-handle ui-resizable-w" aria-hidden="true" aria-label="Resize temporal constraint"></span>
            <span class="glyphicon glyphicon-resize-horizontal ui-resizable-handle ui-resizable-e" aria-hidden="true" aria-label="Resize temporal constraint"></span>
          </div>
          <div id="tempConstId10toId12" class="tempConstraintObject" start="event10" end="event12" type="between" value="2" unit="sec">
            <p class="tempConstraintMessage"></p>
            <span class="glyphicon glyphicon-resize-horizontal ui-resizable-handle ui-resizable-w" aria-hidden="true" aria-label="Resize temporal constraint"></span>
            <span class="glyphicon glyphicon-resize-horizontal ui-resizable-handle ui-resizable-e" aria-hidden="true" aria-label="Resize temporal constraint"></span>
          </div>
          <div id="tempConstId9toId16" class="tempConstraintObject" start="event9" end="event16" type="within" value="30" unit="min">
            <p class="tempConstraintMessage"></p>
            <span class="glyphicon glyphicon-resize-horizontal ui-resizable-handle ui-resizable-w" aria-hidden="true" aria-label="Resize temporal constraint"></span>
            <span class="glyphicon glyphicon-resize-horizontal ui-resizable-handle ui-resizable-e" aria-hidden="true" aria-label="Resize temporal constraint"></span>
          </div>
        </div>
        </div>

        <!-- Dialog to be shown when creating a new Event Template-->
        <div id="eventTemplateDialog" title="Create new Event Template">
          <p class="validateTips">All form fields are required.</p>

          <form>
            <fieldset>
              <label for="name">Name</label>
              <input type="text" name="name" id="name" value="Jane Smith" class="text ui-widget-content ui-corner-all">
              <label for="email">Email</label>
              <input type="text" name="email" id="email" value="jane@smith.com" class="text ui-widget-content ui-corner-all">
              <label for="password">Password</label>
              <input type="password" name="password" id="password" value="xxxxxxx" class="text ui-widget-content ui-corner-all">

              <!-- Allow form submission with keyboard without duplicating the dialog button -->
              <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
          </form>
        </div>

</body>

</html>