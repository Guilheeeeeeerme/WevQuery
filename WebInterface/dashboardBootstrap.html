<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

  <title>User log query abstraction language</title>

  <!-- Bootstrap -->
  <link href="bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styleDrag.css">
  <link rel="stylesheet" href="./jquery-ui-1.12.1/jquery-ui.css">

  <script src="./jquery-ui-1.12.1/external/jquery/jquery.js"></script>
  <!-- WARNING!!! The order of the following two JavaScripts will affect the icons used in the interface (the last one will have priority)-->
  <script src="./jquery-ui-1.12.1/jquery-ui.min.js"></script>
  <script src="bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>

  <!-- tag selection script-->
  <script src="chosen_v1.6.2/chosen.jquery.js"></script>
  <link rel="stylesheet" href="chosen_v1.6.2/chosen.css">



  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  <!-- The event creation and interaction logic is stored in a different file -->
  <script src="./eventCreation.js"></script>

  <script>

  $(function() {
     var $eventPaletteArea = $("#eventPaletteArea"),
      $eventOrderArea = $("#eventOrderArea");      
      
      $eventPaletteArea.sortable({
          scroll: true,
         // revert: true,//when cancelled, element returns to origin with animation
          handle: "span",//elements can only be dragged using the handle
          cancel: "#eventPaletteArea li p",//the rest of the text can be selected
          connectWith: $eventOrderArea,//both areas are conected, so elements can be dragged around,
          helper:"clone",
          //revert:"invalid",
          start: function(event, ui) {
            if ($(ui.item).hasClass("eventOrdered")) {
              throw "cancel";
            }
          },
          stop: function(event, ui) {
            if ($(ui.item).parents('#eventOrderArea').length > 0) {
              //Code to keep a copy of the event in the palette, if it has been dragged to the event order.
              //select the element before the one we are ending the drag on
              var idx = $("#eventOrderArea").children().index($(ui.item[0]))-1;
              var elm = $(ui.item[0]).clone(true);
              
              //if index is greater or equal to 0 then we can put it after that index
              //otherwise, append it to the list as first element 
              if(idx>-1)
                $("#eventOrderArea").children(':eq('+idx+')').after(elm);
              else
                $("#eventOrderArea").prepend(elm);
              $(this).sortable('cancel');
              updateTemporalConstraints();
            }
          }
      });    

      $eventOrderArea.sortable({
          scroll: true,
          //revert: true,
          handle: "span",
          cancel: "#eventOrderArea li p",
          connectWith: $eventPaletteArea,
          containment: "#eventOrderArea",

          stop: function(event, ui) {
            updateTemporalConstraints();
          }
      });
      
      //temporal constraints are resizable
      $('.tempConstraintObject').resizable({
        //resize is triggered when interaction with handles occurs
        handles: "w,e",
        //The height won't change
        maxHeight: 25,
        minHeight: 25,
        //the element should not get too small,
        minWidth: 400,
        //When it stops, it will check the element on top of it, and change the reference events accordingly. 
        stop: function(event, ui) {
          var tempConstraint = $(this);
          var startConstraint = $(tempConstraint).position().left;// + $("#eventOrderArea").scrollLeft();
          var endConstraint = startConstraint + $(tempConstraint).width();

          //We will loop through all events in ordered area to find the new start and end of the constraints 
          var startConstraintFound = false;
          var endConstraintFound = false;

          //Loop through all events in the ordered area to find the one this temporal constraint refers to now.
          //There are other options (such as find element in coordinate X Y) but this approach makes changing selection criteria easy
          //We may want to allow the user to select the event the constraint coveres completely, or rather the one the constraint touches.
          $("#eventOrderArea .eventTemplate").each(function(index,value){
            //get the left and right coordinates of the temp constraint
            var eventLeft = $(this).position().left + $("#eventOrderArea").scrollLeft();
            var eventRight = eventLeft + $(this).width();

            //Check if the start of the constraint falls within the dimensions of this event.If so, update the start reference 
            if(!startConstraintFound && eventLeft <= startConstraint && startConstraint <= eventRight){
              $(tempConstraint).attr("start",$(this).attr("id"));
              startConstraintFound = true;
              //console.log("Found left constraint event: " + index);
            }

            //Check if the end of the constraint falls within the dimensions of this event. If so, update the start reference 
            if(!endConstraintFound && eventLeft <= endConstraint && endConstraint <= eventRight){
              $(tempConstraint).attr("end",$(this).attr("id"));
              endConstraintFound = true;
              //console.log("Found right constraint event: " + index);
            }
          });
          updateTemporalConstraints();
        }
      });

 ///////////Event creation dialog
      // From http://www.whatwg.org/specs/web-apps/current-work/multipage/states-of-the-type-attribute.html#e-mail-state-%28type=email%29
      /*emailRegex = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/,
      name = $( "#name" ),
      email = $( "#email" ),
      password = $( "#password" ),
      allFields = $( [] ).add( name ).add( email ).add( password ),
      tips = $( ".validateTips" );*/

      var eventDialog = $( "#eventTemplateDialog" ).dialog({
        autoOpen: false,//it should not open unless called
        minWHeight: 600,
        minWidth: 500,
        modal: true,//disables all other items in the page
        //Adds two buttons, to either add an Event Template or cancel
        buttons: {
          "Create an Event template": addEventTemplate,
          /*Cancel: function() {
            eventDialog.dialog( "close" );
          }*/
        },
        //The only purpose of the following code is to find the newly generated "close window" element, and fix the icon
        //Clashes between bootstrap and jquery-ui break it by default
        open: function() {
          $(this).closest(".ui-dialog")
            .find(".ui-dialog-titlebar-close")
            .removeClass("ui-dialog-titlebar-close")
            .html("<span class='glyphicon glyphicon-remove' onclick='eventDialog.dialog( 'close');'></span>");
        },
            
        //Pressing the "close" icon topright 
        close: function() {
          eventForm[ 0 ].reset();
          allFields.removeClass( "ui-state-error" );
        }
      });

    //Enables the "submit" function that can be triggered via keyboard
    var eventForm = eventDialog.find( "form" ).on( "submit", function( event ) {
      event.preventDefault();
      addEventTemplate();
    });
 
    //Links the "plus" sign in the example event to the creation of the dialog.
    $( "#newEventButton" ).button().on( "click", function() {
      eventDialog.dialog( "open" );
      //Loads the multiselector
      loadEventNames($("#eventMultiSelector"));

      $("#eventMultiSelector").chosen({
        disable_search_threshold: 10,
        placeholder_text_multiple: "select the events to be considered",
        no_results_text: "Oops, nothing found!",
        width: "95%"
      });
      loadContextTypes($("#eventTemplateDialog .eventContextTable select[name='contextType']"));
      
      $("#eventDialogAddContext").click(function(){
        addContext($("#eventTemplateDialog .eventContextTable"))
        });
      }
    );
    updateTemporalConstraints();
  });

/**TODO: I need to call this function when the elements get dragged*/
  function updateTemporalConstraints(){
 //Update Existing temporal restriction
    
    $("#tempConstraintsArea .tempConstraintObject").each(function( index ) {
      //console.log( "tempConstraintObject number" + index);

      var temConstraintTopPadding = 35*(index+1);

      var $startEvent = $("#"+$(this).attr("start"),"#eventOrderArea");
      var $endEvent = $("#"+$(this).attr("end"),"#eventOrderArea");

      var constraintBottomCoord = $startEvent.position().top + $startEvent.height() + temConstraintTopPadding;

      //We need to add the scroll position to the coordinates
      var constraintLeftCoord = $startEvent.position().left + $("#eventOrderDiv").scrollLeft();
      
      //outerWidth(true) returns the width including the outer margin, which makes the constraints slightly surround the events. 
      var constraintWidth = (($endEvent.position().left + $endEvent.outerWidth(true)) - $startEvent.position().left) + "px";

      //console.log( "Drawing from " + constraintLeftCoord + " with size "+ constraintWidth);

      $(this).css({top: constraintBottomCoord, left: constraintLeftCoord, width: constraintWidth, position:'absolute'});
      $(".tempConstraintMessage",this).text($(this).attr("type") +" "+ $(this).attr("value") +" "+ $(this).attr("unit"))

      //The padding on the bottom will increase depending on the number of constraints. 30px per constraint
      $("#eventOrderDiv").css({
        paddingBottom: (index+1)*40+"px",
      })
    });
  }
  
  
  </script>
</head>

<body>
  <h1> Interaction Dashboard </h1>

  <div id="eventPaletteDiv" class="container">
    <h2> Event Palette </h2>

    <div class="row">
      <li class="eventTemplate eventTemplateExample">
        <div id="templateExample"> Event Example <span id="newEventButton" class="glyphicon glyphicon-plus" aria-hidden="true" aria-label="Add Event"></span></div>
        <p> Events:</p>
        <p>mouseover,mouseout</p>
        <p> Occurrence:</p>
        <p> Context</p>
        <p> ndoeID:"submit"</p>
      </li>

      <ul id="eventPaletteArea">
        <li id="event1" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 1 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
          <p> Events:</p>
          <p>mouseover,mouseout</p>
          <p> Occurrence:</p>
          <p> Context</p>
          <p> ndoeID:"submit"</p>
        </li>
        <li id="event2" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 2 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
          <p> Events:</p>
          <p>mouseover,mouseout</p>
          <p> Occurrence:</p>
          <p> Context</p>
          <p> ndoeID:"submit"</p>
        </li>

        <li id="event3" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 3 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
          <p> Events:</p>
          <p>mouseover,mouseout</p>
          <p> Occurrence:</p>
          <p> Context</p>
          <p> ndoeID:"submit"</p>
        </li>

        <li id="event4" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 4 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
          <p> Events:</p>
          <p>mouseover,mouseout</p>
          <p> Occurrence:</p>
          <p> Context</p>
          <p> ndoeID:"submit"</p>
        </li>

        <li id="event5" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 5 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
          <p> Events:</p>
          <p>mouseover,mouseout</p>
          <p> Occurrence:</p>
          <p> Context</p>
          <p> ndoeID:"submit"</p>
        </li>

        <li id="event6" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 6 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
        </li>
        <li id="event7" class="eventTemplate eventTemplateDraggable">
          <div id="title"> Event 7 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
        </li>
      </ul>
      </div>
      </div>
      <h2> Event Order Area </h2>

      <div id="eventOrderDiv" class="container">
        <ul id="eventOrderArea">
          <li id="event8" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 8 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
            <p> Events:</p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
          </li>
          <li id="event9" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 9 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
            <p> Events:</p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
          </li>

          <li id="event10" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 10 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
            <p> Events:</p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
          </li>

          <li id="event11" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 11 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
            <p> Events:</p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
          </li>

          <li id="event12" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 12 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></div>
            <p> Events:</p>
            <p>mouseover,mouseout</p>
            <p> Occurrence:</p>
            <p> Context</p>
            <p> ndoeID:"submit"</p>
          </li>

          <li id="event13" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 13 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
              <p>mouseover,mouseout</p>
              <p> Occurrence:</p>
              <p> Context</p>
              <p> ndoeID:"submit"</p>
          </li>
          <li id="event14" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 14 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
              <p>mouseover,mouseout</p>
              <p> Occurrence:</p>
              <p> Context</p>
              <p> ndoeID:"submit"</p>
          </li>
          <li id="event15" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 15 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
              <p> Events:</p>
              <p>mouseover,mouseout</p>
              <p> Occurrence:</p>
              <p> Context</p>
              <p> ndoeID:"submit"</p>
          </li>
          <li id="event16" class="eventTemplate eventTemplateDraggable">
            <div id="title"> event 16 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
              <p>mouseover,mouseout</p>
              <p> Occurrence:</p>
              <p> Context</p>
              <p> ndoeID:"submit"</p>
          </li>
          <li id="event17" class="eventTemplate eventTemplateDraggable">
            <div id="title"> Event 17 <span class="glyphicon glyphicon-move" aria-hidden="true" aria-label="Move Event"></span></p>
              <p>mouseover,mouseout</p>
              <p> Occurrence:</p>
              <p> Context</p>
              <p> ndoeID:"submit"</p>
          </li>
        </ul>
        <div id="tempConstraintsArea">
          <div id="tempConstId8toId10" class="tempConstraintObject" start="event8" end="event10" type="within" value="10" unit="sec">
            <p class="tempConstraintMessage"></p>
            <span class="glyphicon glyphicon-resize-horizontal ui-resizable-handle ui-resizable-w" aria-hidden="true" aria-label="Resize temporal constraint"></span>
            <span class="glyphicon glyphicon-resize-horizontal ui-resizable-handle ui-resizable-e" aria-hidden="true" aria-label="Resize temporal constraint"></span>
          </div>
          <div id="tempConstId10toId12" class="tempConstraintObject" start="event10" end="event12" type="between" value="2" unit="sec">
            <p class="tempConstraintMessage"></p>
            <span class="glyphicon glyphicon-resize-horizontal ui-resizable-handle ui-resizable-w" aria-hidden="true" aria-label="Resize temporal constraint"></span>
            <span class="glyphicon glyphicon-resize-horizontal ui-resizable-handle ui-resizable-e" aria-hidden="true" aria-label="Resize temporal constraint"></span>
          </div>
          <div id="tempConstId9toId16" class="tempConstraintObject" start="event9" end="event16" type="within" value="30" unit="min">
            <p class="tempConstraintMessage"></p>
            <span class="glyphicon glyphicon-resize-horizontal ui-resizable-handle ui-resizable-w" aria-hidden="true" aria-label="Resize temporal constraint"></span>
            <span class="glyphicon glyphicon-resize-horizontal ui-resizable-handle ui-resizable-e" aria-hidden="true" aria-label="Resize temporal constraint"></span>
          </div>
        </div>
        </div>

        <!-- Dialog to be shown when creating a new Event template-->
        <div id="eventTemplateDialog" title="Create new Event Template">
          <p class="validateTips">All form fields are required.</p>

          <form class="form-horizontal container">
            <fieldset>
              <div class="form-group">
                <label class="col-lg-3 control-label">Events</label>
                <div class="col-lg-9">
                  <select id="eventMultiSelector" multiple="multiple">
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for=Occurrence class="col-sm-3 control-label">Occurrence:</label>
                <div class="col-sm-6">
                  <input type="text" maxlength="3" class="col-sm-4 occurrenceInput" placeholder="" aria-describedby="input to define minimum occurrence">
                  <label class="col-sm-4">To</label>
                  <input type="text" maxlength="3" class="col-sm-4 occurrenceInput" placeholder="" aria-describedby="input to define maximum occurrence">
                  <p class="hint">Number of occurrences, it can be a number or an interval</p>
                </div>
              </div>

              <div class="form-group">
                <label for="Context" class="col-sm-3 control-label">Context:</label>
              </div>
              <div class="form-group">
                <table border="1" class="eventContextTable">
                  <tr>
                    <td>name</td>
                    <td>value</td>
                    <td></td>
                  </tr>
                  <tr>
                    <td>
                      <select name="contextType">
                        <option value="" selected disabled>Please select</option>
                        <optgroup label="Swedish Cars">
                        <option value="volvo">Volvo</option>
                        <option value="saab">Saab</option>
                        <optgroup label="Other Cars">
                        <option value="fiat">Fiat</option>
                        <option value="audi">Audi</option>
                      </select>
                    </td>
                    <td>
                      <input name="contextValue" type="text" placeholder="Introduce value" aria-describedby="Introduce value">
                    </td>
                    <td><span id ="eventDialogAddContext" class="glyphicon glyphicon-plus" aria-hidden="true"></span></td>
                  </tr>
                </table>
              </div>
              <!-- Allow form submission with keyboard without duplicating the dialog button -->
              <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
          </form>
        </div>

        <!-- Dialog to be shown when creating a new Temporal Contraint-->
        <div id="temporalCostraintDialog" title="Create new Temporal Contraint">
          <p class="validateTips">All form fields are required.</p>

          <form class="form-horizontal container">
            <fieldset>
              <div class="form-group">
                <label for="Relation" class="col-sm-3 control-label">Relation:</label>
                <div class="col-sm-6">
                  <div class="radio">
                    <label><input type="radio" name="optradio">Within</label>
                  </div>
                  <div class="radio">
                    <label><input type="radio" name="optradio">Separated by</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label for="Events" class="col-sm-3 control-label">Events:</label>
                <div class="col-sm-6">
                  <button class="btn btn-default" type="button">Event1</button>
                  <button class="btn btn-default" type="button">Event2</button>
                  <p class="hint">Click on an event to change the selection</p>
                </div>
              </div>

              <div class="form-group">
                <label for="Duration" class="col-sm-3 control-label">Duration:</label>
                <input type="text" class="col-sm-6" placeholder="insert duration" aria-describedby="Text input for duration">
              </div>
              <div class="form-group">
                <label for="Unit" class="col-sm-3 control-label">Unit:</label>
                <div class="col-sm-6">
                  <div class="radio">
                    <label><input type="radio" name="optradio">Seconds</label>
                  </div>
                  <div class="radio">
                    <label><input type="radio" name="optradio">Minutes</label>
                  </div>
                </div>
              </div>
              <!-- Allow form submission with keyboard without duplicating the dialog button -->
              <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
          </form>
        </div>

</body>

</html>

